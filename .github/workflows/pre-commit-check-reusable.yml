# ABOUTME: Reusable workflow to run pre-commit hooks with environment caching (catches bypassed hooks)
# PERMISSIONS: contents: read - Required to checkout code and fetch git history for changed files
# SECURITY: Read-only workflow - no modifications to repository or PRs
name: Pre-commit Check (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for pre-commit'
        type: string
        default: '3.x'
      base-branch:
        description: 'Base branch to compare against for changed files'
        type: string
        default: 'master'
      run-on-all-files:
        description: 'Run pre-commit on all files instead of just changed files'
        type: boolean
        default: false

permissions:
  contents: read  # Required: Checkout code and fetch git history for changed files

jobs:
  run-pre-commit:
    name: Run Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit

          # Cache key structure ensures proper invalidation:
          # - runner.os: Prevents Linux/Windows/macOS cache incompatibility
          # - inputs.python-version: Ensures hooks match Python environment
          # - hashFiles('.pre-commit-config.yaml'): Invalidates when hooks change
          key: precommit-${{ runner.os }}-py${{ inputs.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}

          # Fallback strategy: Reuse cache with same OS/Python but different config
          # This allows partial hook reuse when config changes (only re-install changed hooks)
          restore-keys: |
            precommit-${{ runner.os }}-py${{ inputs.python-version }}-

      - name: Install and cache UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install pre-commit
        run: uv tool install pre-commit

      - name: Report pre-commit cache statistics
        if: always()
        run: |
          echo "### Pre-commit Cache Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Cache location: ~/.cache/pre-commit" >> $GITHUB_STEP_SUMMARY

          # Get cache size safely (may not exist on first run)
          if [[ -d ~/.cache/pre-commit ]]; then
            CACHE_SIZE=$(du -sh ~/.cache/pre-commit 2>/dev/null | cut -f1 || echo "N/A")
            echo "- Cache size: $CACHE_SIZE" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Cache size: N/A (first run or cache miss)" >> $GITHUB_STEP_SUMMARY
          fi

          # Get pre-commit version
          PRECOMMIT_VERSION=$(pre-commit --version 2>/dev/null || echo "N/A")
          echo "- Pre-commit version: $PRECOMMIT_VERSION" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Pre-commit environment ready (see timing in previous step)" >> $GITHUB_STEP_SUMMARY

      - name: Run pre-commit hooks
        run: |
          echo "üîç Running pre-commit hooks..."
          echo "This catches bypassed hooks (--no-verify usage)"
          echo ""

          if [[ "${{ inputs.run-on-all-files }}" == "true" ]]; then
            echo "Running on all files..."
            pre-commit run --all-files
          else
            echo "Running on changed files (vs ${{ inputs.base-branch }})..."
            # Run pre-commit on all changed files between base branch and HEAD
            pre-commit run --from-ref origin/${{ inputs.base-branch }} --to-ref HEAD
          fi

      - name: Verify compliance
        run: |
          echo "‚úÖ All pre-commit hooks passed"
          echo ""
          echo "This ensures code quality even if someone used --no-verify locally"
